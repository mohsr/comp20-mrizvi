<!doctype html>
<html>
	<head>
		<title>Not Uber</title>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<link href="style.css" rel="stylesheet">
		<script>
			var user = "22CM1fog3P";
			var lat  = 9999;
			var lng  = 9999;
			var data;
			var key;
			var whereami;
			var opts;
			var map;

			function init() {
				getLocation();
			}

			function getLocation() {
				navigator.geolocation.getCurrentPosition(function(position) {
					lat = position.coords.latitude;
					lng = position.coords.longitude;

					getData();
				});
			}

			function outputLocation() {
				locElem = document.getElementById("myloc");
				locElem.innerHTML = "<h3>You are at " + lat + ", " + 
				                   lng + "</h3>"
			}

			function getData() {
				var req = new XMLHttpRequest;
				req.open("POST", "https://jordan-marsh.herokuapp.com/rides", true);
				req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				req.onreadystatechange = function() {
					if (req.readyState == 4 && req.status == 200) {
						data = JSON.parse(req.responseText);
						processData();
					}
				}
				req.send("username=" + user + "&lat=" + lat + "&lng=" + lng);
			}

			function processData() {
				if (data.hasOwnProperty("vehicles")) {
					key = "vehicles";
				} else {
					key = "passengers";
				}

				makeMap();
			}

			function makeMap() {
				whereami = new google.maps.LatLng(lat, lng);
				opts = {
					zoom: 15,
					center: whereami,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById("map"), opts);
				map.panTo(whereami);

				myMarker = new google.maps.Marker({
					position: whereami,
					title: "Here you are!"
				});
				myMarker.setMap(map);

				info = new google.maps.InfoWindow();
			}

			function printJSON() {
				dataElem = document.getElementById("data");
				out = "";

				for (i = 0; i < data[key].length; i++) {
					out += "<p class=\"unit\">";
					out += "Username: " + data[key][i].username + "</br>";
					out += "Latitude: " + data[key][i].lat + "</br>";
					out += "Longitude: " + data[key][i].lng + "</br>";
					out += "</p>";
				}
				dataElem.innerHTML = out;
			}
		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAT1NNtcXCNnupSRZVdfQBL_hbRg6X6FBI&callback=init"></script>
	</head>
	<body>
		<div id="map">
			<h3>Loading map...</h3>
		</div>
	</body>
</html>
